---
title: "CARapp"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CARapp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

#Pacote CAR_APP

Este documento descreve as funcionalidades do pacote "CARapp". O Objetivo do pacote é auxiliar na delimitação dos passivos ambientais  nas áreas de preservação permanentes (APPs) hídricas de propriedades rurais no território brasileiro.

Com a promulgação da Lei de Proteção da Vegetação Nativa (LPVN - [Lei 12.651, de 25 de maio de 2012](http://www.planalto.gov.br/ccivil_03/_ato2011-2014/2012/lei/l12651.htm), ou Novo Código Florestal) em 2012, a delimitação das Áreas de Preservação Permanentes (APPs) passíveis de serem restauradas foi alterada, e tornou-se dependente do tamanho das propriedades, baseado no número de módulos fiscais. Consequentemente,  informações referentes ao tamanho do módulo fiscal, que varia de município para município, e o tamanho da propriedade, que pode ser obtido através do [CAR](https://www.car.gov.br/) (Cadastro Ambiental Rural) são necessárias para a correta delimitação das áreas de passivo ambiental.

Este pacote busca auxiliar exatamente nessa tarefa, particularmente focando no cálculo das APPs de cursos d'água de acordo com o tamanho das propriedades cadastradas no *Sistema Nacional de Cadastro Ambiental Rural* ([SICAR](https://www.car.gov.br/publico/imoveis/index)).

Para a criação das áreas a serem restauradas é usado a hidrografia disponibilizada na base de dados da Fundação Brasileira para o Desenvolvimento Sustentável ([FBDS](https://www.fbds.org.br/), os dados podem ser encontrados no link <http://geo.fbds.org.br/>. 

As informações cartográficas sobre o uso do solo podem ser de diversas fontes. O padrão é o dado também disponível na base de dados da [FBDS](https://www.fbds.org.br/), contudo outras fontes de dados como o MapBiomas, ou qualquer outro mapeamento, também podem ser utilizados para fornecer estas informações.

Inicialmente precisamos baixar o pacote *CARapp* e iremos fazer isso do [repositório do NEEDS](https://github.com/NEEDS-LS) no gitHub. Caso você não tenha o pacote devtools, comece baixando ele.
```{r, eval=FALSE}
install.packages("devtools")
library(devtools)
```

E agora baixo o pacote CARapp do nosso diretório.
```{r, eval=TRUE, message=FALSE}
devtools::install_github("NEEDS-LS/CARapp")
```

```{r setup}
library(CARapp)
```

No nosso pacote estão disponíveis uma série de dados para você se familiarizar com o pacote. Agora iremos verificar quais conjuntos de dados tempos disponíveis.
```{r}
data(package = "CARapp") 
```

Iremos usar como exemplo os dados do município de Campina do Monte Alegre, no estado de São Paulo. Esse município é muito próximo do campus [Lagoa do Sino](https://www.lagoadosino.ufscar.br/) da Universidade Federal de São Carlos ([UFSCar](https://www2.ufscar.br/))onde o [NEEDS](https://www.needs.ufscar.br/) fica locaizado.

```{r, eval=TRUE}
load("./data/CMA.RData")
```


Uma vantagem é que Campina do Monte Alegre é um município de dimensões pequenas, o que facilita usá-lo como município para demonstração. 
```{r, eval=FALSE}
plot()
```

Apenas para gravar e salvar os dados, depois tira da vignette
```{r, eval=FALSE, echo=FALSE}
CMA_CAR<-readOGR(dsn="./data_use/CAR/Campina do Monte Alegre",
                  layer="AREA_IMOVEL", use_iconv=TRUE, encoding="UTF-8")
#mapa_MDA = mapa com as massas d'água disponibilizado pela FBDS
CMA_MDA<-readOGR(dsn="./data_use/FBDS_Hidrografia",
                  layer="SP_3509452_MASSAS_DAGUA", use_iconv=TRUE,encoding="UTF-8")
#mapa_NAS = mapa com as nascentes fornecido disponibilizado FBDS
CMA_NAS<-readOGR(dsn="./data_use/FBDS_Hidrografia",
                  layer="SP_3509452_NASCENTES", use_iconv=TRUE, encoding="UTF-8")
#mapa_RMS = mapa com os rios de margem simples disponibilizado pela FBDS
CMA_RMS<-readOGR(dsn="./data_use/FBDS_Hidrografia",
                  layer="SP_3509452_RIOS_SIMPLES", use_iconv=TRUE, encoding="UTF-8")
#mapa_RMD = mapa com os rios de margem dupla disponibilzados pela FBDS
CMA_RMD<-readOGR(dsn="./data_use/FBDS_Hidrografia",
                  layer="SP_3509452_RIOS_DUPLOS", use_iconv=TRUE, encoding="UTF-8")
#mapa_USO = mapa com o uso do solo da região em análise, pode ser da FBDS ou MapBiomas
CMA_USO<-readOGR(dsn="./data_use/FBDS_APP_USO_Municipios",
                  layer="SP_3509452_USO", use_iconv=TRUE, encoding="UTF-8")
#mapa_MUN = mapa com o limite do(s) município(s) em análise
mapa_MUN<-readOGR(dsn="./data_use/LIMITE_MUN_JUNTOS",
                  layer="muni_ALPA", use_iconv=TRUE, encoding="UTF-8")
#Agora tem q recortar apenas CMA
#CMA_MUN<-mapa_MUN[mapa_MUN@data$NOME_MUN == "Campina do Monte Alegre",]

#Acerta as coordenadas
CMA_CAR <- CRS_proj(CMA_CAR, 31982)
CMA_USO <- CRS_proj(CMA_USO, 31982)
CMA_RMD <- CRS_proj(CMA_RMD, 31982)
CMA_RMS <- CRS_proj(CMA_RMS, 31982)
CMA_MDA <- CRS_proj(CMA_MDA, 31982)
CMA_NAS <- CRS_proj(CMA_NAS, 31982)
CMA_MUN <- CRS_proj(CMA_MUN, 31982)
````

Depois tira da vignette
```{r, eval=FALSE}
save(CMA_CAR, CMA_MDA, CMA_NAS, CMA_RMS, CMA_RMD, CMA_USO, CMA_MUN, file = "./data/CMA.RData")
```

Precisa ver o que precisa manter dessa parte

##################################################


A próxima etapa é de extrema importância para a execução das funções deste pacote, a partir de 2019/2020 passou a ser adotado dentro do sistema de coordenadas o PROJ6 e GDAL3, que causou algumas mudanças na forma que o CRS (Coordinate Reference System) é usado. Está mudança pode ser identificada já na entrada dos dados, caso apareça uma warning:

```{r, eval=FALSE, echo=FALSE, warning=TRUE, results='hide', message=FALSE}
mapa_MDA<-readOGR(dsn="../data_use/FBDS_Hidrografia",
                  layer="SP_3509452_MASSAS_DAGUA", use_iconv=TRUE,encoding="UTF-8")
```

Caso isso ocorra o processo de mudança da projeção poderá ser feita pela função *CRS_proj()*, tendo como entrada o CRS destino e o objeto a ser reprojetado. Caso a projeção do objeto esteja correta mas o warning foi exibido ainda é necessário reprojeta-lo para o CRS desejado. Neste exemplo usaremos o SIRGAS 2000/UTM 22S (EPSG: 31982).

```{r, eval=FALSE, echo=TRUE, warning=FALSE, message=FALSE}
mapa_CAR <- CRS_proj(mapa_CAR, 31982)
mapa_USO <- CRS_proj(mapa_USO, 31982)
mapa_RMD <- CRS_proj(mapa_RMD, 31982)
mapa_RMS <- CRS_proj(mapa_RMS, 31982)
mapa_MDA <- CRS_proj(mapa_MDA, 31982)
mapa_NAS <- CRS_proj(mapa_NAS, 31982)
mapa_MUN <- CRS_proj(mapa_MUN, 31982)
```

#################################################

Aqui eu acho q precisamos ver, pq a funcao separaTamanho() acho q tvz deva ir para dentro da funcao q vai ser corrigiga para ficar independente do tamanho. 



